# Verbatim Studio - Bundled Configuration
# This file is embedded in the Electron app and manages all transcription services
# Images are pulled from GitHub Container Registry (ghcr.io)

services:
  # FastAPI backend server
  api-server:
    image: ghcr.io/morbidsteve/verbatim-server:latest
    ports:
      - "8000:8000"
    volumes:
      - verbatim-data:/app/data
      - verbatim-uploads:/app/uploads
    environment:
      - DATABASE_URL=sqlite:///app/data/verbatim.db
      - WHISPER_SERVICE_URL=http://whisper-service:8001
      - DIARIZATION_SERVICE_URL=http://diarization:8000
      - DEBUG=false
    depends_on:
      - whisper-service
      - diarization
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # WhisperX for file transcription (CPU mode for broad compatibility)
  whisper-service:
    image: ghcr.io/morbidsteve/verbatim-whisper:latest
    ports:
      - "8001:8001"
    volumes:
      - whisper-models:/app/models
      - verbatim-uploads:/app/uploads
    environment:
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-small}
      - WHISPER_DEVICE=cpu
      - WHISPER_COMPUTE_TYPE=int8
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # Speaker diarization
  diarization:
    image: ghcr.io/morbidsteve/verbatim-diarization:latest
    ports:
      - "8003:8000"
    volumes:
      - diarization-models:/app/models
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
      - DEVICE=cpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

volumes:
  verbatim-data:
    name: verbatim-studio-data
  verbatim-uploads:
    name: verbatim-studio-uploads
  whisper-models:
    name: verbatim-studio-whisper-models
  diarization-models:
    name: verbatim-studio-diarization-models
